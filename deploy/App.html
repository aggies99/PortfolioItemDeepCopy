<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Deep Copy</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){MyApp=this,MyApp.globalContext=this.getContext().getDataContext(),MyApp.epicList=[],MyApp.defaultEpic=MyApp.selectedEpic="All Epics",MyApp.epicList.push(MyApp.selectedEpic),MyApp.mmfList=[],MyApp.defaultMMF=MyApp.selectedMMF="All MMFs",MyApp.mmfList.push(MyApp.selectedMMF),MyApp.featureList=[],MyApp.defaultFeature=MyApp.selectedFeature="All Features",MyApp.featureList.push(MyApp.selectedFeature),MyApp._loadPortfolioEpics()},_wrapComponent:function(component,cls){var wrapper=Ext.create("Ext.container.Container",{componentCls:cls});return wrapper.add(component),wrapper},_loadPortfolioEpics:function(){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:1/0,model:"PortfolioItem/Epic",context:MyApp.globalContext,fetch:["Name","FormattedID"],sorters:{property:"Rank",direction:"ASC"},listeners:{load:function(myStore,records){var index=0;for(index=0;records.length>index;index++)MyApp.epicList.push(records[index].data.FormattedID+": "+records[index].data.Name);MyApp._drawEpicComboBox()}}})},_drawEpicComboBox:function(){MyApp.epicCombo=Ext.create("Ext.form.ComboBox",{fieldLabel:"Epic Items",store:MyApp.epicList,width:700,listeners:{change:function(combo,newVal){MyApp.selectedEpic=newVal.split(":")[0],MyApp._loadPortfolioMMFs()}}}),MyApp.programPane=Ext.create("Ext.container.Container",{componentCls:"inner"}),MyApp.add(MyApp._wrapComponent(MyApp.programPane,"epicList")),MyApp.programPane.add(MyApp.epicCombo),MyApp.epicCombo.setValue(MyApp.epicList[1])},_loadPortfolioMMFs:function(){MyApp.mmfList.length=1;var myEpicFilter=[];MyApp.selectedEpic!=MyApp.defaultEpic&&(myEpicFilter=Ext.create("Rally.data.QueryFilter",{property:"Parent.FormattedID",operator:"=",value:MyApp.selectedEpic})),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:1/0,model:"PortfolioItem/MMF",context:MyApp.globalContext,fetch:["Name","FormattedID","Parent"],filters:myEpicFilter,sorters:{property:"Rank",direction:"ASC"},listeners:{load:function(myStore,records){var index=0;for(index=0;records.length>index;index++)MyApp.mmfList.push(records[index].data.FormattedID+": "+records[index].data.Name);MyApp._drawMMFComboBox()}}})},_drawMMFComboBox:function(){void 0!==MyApp.mmfCombo&&MyApp.programPane.remove(MyApp.mmfCombo),MyApp.mmfCombo=Ext.create("Ext.form.ComboBox",{fieldLabel:"MMF Items",store:MyApp.mmfList,width:700,listeners:{change:function(combo,newVal){MyApp.selectedMMF=newVal.split(":")[0],MyApp._loadPortfolioFeatures()}}}),MyApp.programPane.add(MyApp.mmfCombo),MyApp.mmfCombo.setValue(MyApp.mmfList[1])},_loadPortfolioFeatures:function(){MyApp.featureList.length=1;var myFeatureFilter=[];MyApp.selectedMMF!=MyApp.defaultMMF&&(myFeatureFilter=Ext.create("Rally.data.QueryFilter",{property:"Parent.FormattedID",operator:"=",value:MyApp.selectedMMF})),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:1/0,model:"PortfolioItem/Feature",context:MyApp.globalContext,fetch:["Name","FormattedID","Parent"],filters:myFeatureFilter,sorters:{property:"Rank",direction:"ASC"},listeners:{load:function(myStore,records){var index=0;for(index=0;records.length>index;index++)MyApp.featureList.push(records[index].data.FormattedID+": "+records[index].data.Name);MyApp._drawFeatureComboBox()}}})},_drawFeatureComboBox:function(){void 0!==MyApp.featureCombo&&MyApp.programPane.remove(MyApp.featureCombo),MyApp.featureCombo=Ext.create("Ext.form.ComboBox",{fieldLabel:"Feature Items",store:MyApp.featureList,width:700,listeners:{change:function(combo,newVal){MyApp.selectedFeature=newVal.split(":")[0],MyApp._drawCopyButton()}}}),MyApp.programPane.add(MyApp.featureCombo),MyApp.featureCombo.setValue(MyApp.featureList[1]),MyApp._drawCopyButton()},_determineWhatToCopy:function(){return MyApp.CopyId="Nothing",MyApp.selectedFeature!=MyApp.defaultFeature?MyApp.CopyId=MyApp.selectedFeature:MyApp.selectedMMF!=MyApp.defaultMMF?MyApp.CopyId=MyApp.selectedMMF:MyApp.selectedEpic!=MyApp.defaultEpic&&(MyApp.CopyId=MyApp.selectedEpic),MyApp.CopyId},_drawCopyButton:function(){void 0!==MyApp.copyButton&&MyApp.programPane.remove(MyApp.copyButton),MyApp.copyButton=Ext.create("Ext.Container",{items:[{xtype:"rallybutton",text:"Copy "+MyApp._determineWhatToCopy(),handler:MyApp._copyButtonHandler}]}),"Nothing"!=MyApp.CopyId&&MyApp.programPane.add(MyApp.copyButton)},_copyButtonHandler:function(){if(MyApp.featuresToCopy=[],MyApp.defaultFeature!==MyApp.selectedFeature)MyApp.featuresToCopy=[MyApp.selectedFeature];else for(index=1;MyApp.featureList.length>index;index++)MyApp.featuresToCopy[index-1]=MyApp.featureList[index].split(":")[0];for(index=0;MyApp.featuresToCopy.length>index;index++)MyApp.singleFeatureToCopy=MyApp.featuresToCopy[index],MyApp._userStoryDeepCopy(1)},_userStoryDeepCopy:function(currentPage){thisStore=Ext.create("Rally.data.WsapiDataStore",{pageSize:1,limit:1,model:"UserStory",context:MyApp.globalContext,fetch:["FormattedID","Parent","Feature"],filters:[{property:"Feature.FormattedID",operator:"=",value:MyApp.singleFeatureToCopy},{property:"Parent",operator:"=",value:null}],listeners:{load:function(myStore,records){console.log(records),myStore.totalCount>0&&(MyApp._startCopy(records[0].data.FormattedID),myStore.currentPage<myStore.totalCount&&MyApp._userStoryDeepCopy(myStore.currentPage+1))}}}),thisStore.loadPage(currentPage)},_startCopy:function(storyFormattedID){console.log(storyFormattedID),SingleDeepCopy(storyFormattedID)}});
                SingleDeepCopy=function(selectedValue){var dataSource=new rally.sdk.data.RallyDataSource("__WORKSPACE_OID__","__PROJECT_OID__","__PROJECT_SCOPING_UP__","__PROJECT_SCOPING_DOWN__"),copy=new rally.StoryDeepCopy(dataSource,config);copy.copyStory(rally.sdk.util.Ref.getRelativeRef(selectedValue),storyCopied)},rally.StoryDeepCopy=function(rallyDataSource,config){function getTypeFromRef(ref){if(rally.sdk.util.Ref.isRef(ref)){var list=ref.split("/");return list.pop(),list.pop()}throw"Function getTypeFromRef expected a Rally Reference."}var storyBuffer=[],firstStory=null,finishedCallback,that=this;this._fireEvent=function(eventName,eventArgs){config&&config.eventListeners[eventName]&&dojo.isFunction(config.eventListeners[eventName])&&config.eventListeners[eventName](that,eventArgs)},this.filterObject=function(object){delete object.Discussion,delete object.Rank,delete object.LastUpdateDate,delete object.Attachments,delete object.AcceptedDate,delete object.Blocker,delete object.Defects,delete object.TaskActualTotal,delete object.TaskEstimateTotal,delete object.TaskRemainingTotal,delete object.TaskEstimateTotal,delete object.RevisionHistory,delete object.Subscription,delete object.FormattedID,delete object.CreationDate,delete object.Changesets,delete object.ObjectID;for(var j in object)"_"==j.substring(0,1)&&delete object[j];return object},this._addObject=function(object,typeName,callback){function errorFunctionWrapper(error){if(dojo.isArray(error.Errors)){var errorMessage=error.Errors.pop();errorMessage.indexOf("Not authorized to create:")>=0&&(errorMessage="Unable to create an object. This can happen due to a child or task being in a project you do not have write permissions to."),rally.sdk.ui.AppHeader.showMessage("error",errorMessage,1e4)}else dojo.isObject(error)&&error.message&&(rally.sdk.ui.AppHeader.showMessage("error",error.message,1e4),error=[error.message]);config&&dojo.isFunction(config.onError)&&config.onError(error)}var item=dojo.clone(object);item=this.filterObject(item),console.log("addObject")},this._copyAllFromBuffer=function(){if(storyBuffer.length>0){var story=storyBuffer.pop();that._copyStory(story.ref,story.parent,that._copyAllFromBuffer)}else finishedCallback&&finishedCallback(firstStory)},this._addStoriesToBuffer=function(storyArray,parentRef){dojo.forEach(storyArray,function(story){storyBuffer.push({ref:story._ref,parent:parentRef})})},this._copyStory=function(ref,parentRef,callback){rallyDataSource.getRallyObject(ref,function(foundObject){var type=getTypeFromRef(ref);that._fireEvent("storyPreAdd",{story:foundObject}),parentRef?foundObject.Parent=parentRef:foundObject.Name="(Copy of) "+foundObject.Name,that._addObject(foundObject,type,function(storyRef){firstStory||(firstStory=storyRef),that._fireEvent("storyPostAdd",{}),that._addStoriesToBuffer(foundObject.Children,storyRef),that._copyTasksToStory(foundObject.Tasks,storyRef,callback)},null)})},this._copyTasksToStory=function(tasks,storyRef,callback){var localTasks=tasks.slice(0);if(localTasks.length>0){var task=localTasks.pop();that._copyTask(task._ref,storyRef,function(){that._copyTasksToStory(localTasks,storyRef,callback)})}else callback()},this._copyTask=function(ref,storyRef,callback){rallyDataSource.getRallyObject(ref,function(foundObject){var type=getTypeFromRef(ref);foundObject.WorkProduct=storyRef,that._fireEvent("taskPreAdd",{task:foundObject}),that._addObject(foundObject,type,function(ref,warnings){callback&&(that._fireEvent("taskPostAdd",[ref]),callback())},null)})},this.copyStory=function(ref,callback){that._copyStory(ref,void 0,that._copyAllFromBuffer),finishedCallback=callback}};

            Rally.launchApp('CustomApp', {
                name:"Portfolio Deep Copy",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

.inner {
    padding: 10px;
}

.epicList {
    float: left;
    width: 100%;
}

    </style>
</head>
<body></body>
</html>
